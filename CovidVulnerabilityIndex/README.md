A Package for Validating the Covid-19 Vulnerability Index Over OHDSI
========================================================

This package implements the model developed in https://arxiv.org/pdf/2003.07347.pdf called the covid-19 vulnerability index on any data in the OMOP CDM format.

Instructions on the inputs and outputs of the package: 
Vignette: [Using the package skeleton for validating exisitng prediction studies](https://raw.githubusercontent.com/OHDSI/SkeletonExistingPredictionModelStudy/master/inst/doc/UsingSkeletonPackage.pdf)


Instructions To Install and Run Package From Github
===================

- Make sure you have PatientLevelPrediction installed:

```r
  # get the latest PatientLevelPrediction
  install.packages("devtools")
  devtools::install_github("OHDSI/PatientLevelPrediction")
  # check the package
  PatientLevelPrediction::checkPlpInstallation()
```

- Then install the study package:
```r
  # install the network package
  devtools::install_github("ohdsi-studies/Covid19PredictionStudies/CovidVulnerabilityIndex")
```

- Execute the study by running the code in (extras/CodeToRun.R) but make sure to edit the settings:
```r
library(CovidVulnerabilityIndex)
# USER INPUTS
#=======================
# Specify where the temporary files (used by the ff package) will be created:
options(fftempdir = "location with space to save big data")

# The folder where the study intermediate and result files will be written:
outputFolder <- "./CovidVulnerabilityIndexResults"

# Details for connecting to the server:
dbms <- "you dbms"
user <- 'your username'
pw <- 'your password'
server <- 'your server'
port <- 'your port'

connectionDetails <- DatabaseConnector::createConnectionDetails(dbms = dbms,
                                                                server = server,
                                                                user = user,
                                                                password = pw,
                                                                port = port)

# Add the database containing the OMOP CDM data
cdmDatabaseSchema <- 'cdm database schema'
# Add a database with read/write access as this is where the cohorts will be generated
cohortDatabaseSchema <- 'work database schema'
oracleTempSchema <- NULL

# table name where the cohorts will be generated
cohortTable <- 'CovidVulnerabilityIndexCohort'

sampleSize <- NULL
minCellCount <- 5
# endDays is the day relative to index last used by the covariates
endDay <- -1 

# target and outcome cohort settings:
#=============================
# OPTION 1 [default]
# if you want to use the default T and O definions then set 
# usePackageCohorts to TRUE
usePackageCohorts = TRUE

# OPTION 2 
# if you want to use different cohorts then create them into
# a cohort table such as [your database schema].[your cohort table name]
# and then specify what the id for T and O are:
# make sure to set usePackageCohorts to FALSE
## usePackageCohorts = FALSE
newTargetCohortId = 15206
newOutcomeCohortId = 15204
newCohortDatabaseSchema = 'your database schema'
newCohortTable = 'your cohort table name'


# Pick what you want to run:
#============================
# to insert the target/outcome cohorts and create the variables:
createCohorts = TRUE
# To run the model and evaluate it:
runAnalyses = TRUE
# To view the results in a shiny app:
viewShiny = TRUE
# To package the results ready to share:
packageResults = TRUE


# TAR settings - recommended NOT to edit
#=============================
riskWindowStart <- 0
startAnchor <- 'cohort start'
riskWindowEnd <- 30
endAnchor <- 'cohort start'
firstExposureOnly <- F
removeSubjectsWithPriorOutcome <- F
priorOutcomeLookback <- 99999
requireTimeAtRisk <- F
minTimeAtRisk <- 1
includeAllOutcomes <- T

standardCovariates <- FeatureExtraction::createCovariateSettings(useDemographicsAge= T, 
                                                                 useDemographicsGender = T, 
                                                                 useVisitConceptCountLongTerm = T,
                                                                 endDay = endDay,
                                                                 excludedCovariateConceptIds = 8532 )

                                                  
execute(connectionDetails = connectionDetails,
        usePackageCohorts = usePackageCohorts,
        newTargetCohortId = newTargetCohortId,
        newOutcomeCohortId = newOutcomeCohortId,
        newCohortDatabaseSchema = newCohortDatabaseSchema,
        newCohortTable = newCohortTable,
        cdmDatabaseSchema = cdmDatabaseSchema,
        cdmDatabaseName = cdmDatabaseName,
        cohortDatabaseSchema = cohortDatabaseSchema,
        cohortTable = cohortTable,
        sampleSize = sampleSize,
        riskWindowStart = riskWindowStart,
        startAnchor = startAnchor,
        riskWindowEnd = riskWindowEnd,
        endAnchor = endAnchor,
        firstExposureOnly = firstExposureOnly,
        removeSubjectsWithPriorOutcome = removeSubjectsWithPriorOutcome,
        priorOutcomeLookback = priorOutcomeLookback,
        requireTimeAtRisk = requireTimeAtRisk,
        minTimeAtRisk = minTimeAtRisk,
        includeAllOutcomes = includeAllOutcomes,
        standardCovariates = standardCovariates,
        endDay = endDay,
        outputFolder = outputFolder,
        createCohorts = createCohorts,
        runAnalyses = runAnalyses,
        viewShiny = viewShiny,
        packageResults = packageResults,
        minCellCount = minCellCount,
        verbosity = "INFO",
        cdmVersion = 5)
```
# Development status
Under development.
